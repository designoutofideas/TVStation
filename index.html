<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>TVStation — RFA 24/7</title>
<style>
@import url('https://fonts.googleapis.com/css2?family=Share+Tech+Mono&family=Bebas+Neue&family=IBM+Plex+Mono:wght@300;400;600&display=swap');
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
:root{--amber:#ffb700;--dim:#7a5800;--red:#ff3b1f}
html,body{width:100%;height:100%;background:#000;overflow:hidden;font-family:'Share Tech Mono',monospace;color:var(--amber)}
body::before{content:'';position:fixed;inset:0;z-index:100;pointer-events:none;background:repeating-linear-gradient(0deg,rgba(0,0,0,0.13) 0,rgba(0,0,0,0.13) 1px,transparent 1px,transparent 3px)}
body::after{content:'';position:fixed;inset:0;z-index:99;pointer-events:none;background:radial-gradient(ellipse at center,transparent 48%,rgba(0,0,0,0.92) 100%)}
#screen{position:fixed;inset:0;background:#000}
#player{width:100%;height:100%;object-fit:contain;display:block}
#hud{position:fixed;inset:0;z-index:90;pointer-events:none;display:flex;flex-direction:column;justify-content:space-between;padding:22px 30px}
.hud-top{display:flex;justify-content:space-between;align-items:flex-start}
.sid{font-family:'Bebas Neue',cursive;font-size:clamp(24px,3.5vw,48px);letter-spacing:.12em;color:var(--amber);text-shadow:0 0 18px var(--amber);line-height:1}
.ssub{font-family:'IBM Plex Mono',monospace;font-size:8px;font-weight:300;letter-spacing:.35em;color:var(--dim);display:block;margin-top:4px}
.live-row{display:flex;align-items:center;gap:6px;margin-top:8px;font-family:'IBM Plex Mono',monospace;font-size:9px;font-weight:600;letter-spacing:.22em;color:var(--red);text-shadow:0 0 8px var(--red)}
.dot{width:6px;height:6px;border-radius:50%;background:var(--red);box-shadow:0 0 7px var(--red);animation:blink 1.4s ease-in-out infinite}
@keyframes blink{0%,100%{opacity:1}50%{opacity:.1}}
.clk{text-align:right}
#clock{font-family:'Bebas Neue',cursive;font-size:clamp(18px,2.8vw,38px);letter-spacing:.08em;color:var(--amber);text-shadow:0 0 12px var(--amber);display:block}
#dateline{font-family:'IBM Plex Mono',monospace;font-size:8px;letter-spacing:.2em;color:var(--dim);margin-top:3px}
.hud-bot{display:flex;flex-direction:column;gap:7px}
.ptrack{width:100%;height:2px;background:rgba(255,183,0,.08)}
#pfill{height:100%;background:var(--amber);box-shadow:0 0 5px var(--amber);width:0%;transition:width 1s linear}
.irow{display:flex;justify-content:space-between;align-items:flex-end;gap:14px}
.ncol{flex:1;min-width:0}
.lbl{font-family:'IBM Plex Mono',monospace;font-size:7px;font-weight:600;letter-spacing:.3em;color:var(--dim);text-transform:uppercase;margin-bottom:4px}
#now-title{font-family:'Bebas Neue',cursive;font-size:clamp(14px,2.4vw,34px);letter-spacing:.06em;color:var(--amber);text-shadow:0 0 16px rgba(255,183,0,.4);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;max-width:60vw}
#genre{display:inline-block;font-family:'IBM Plex Mono',monospace;font-size:7px;font-weight:600;letter-spacing:.2em;color:#000;background:var(--dim);padding:2px 6px;margin-top:4px}
.xcol{text-align:right;min-width:160px;max-width:240px}
#next-title{font-family:'IBM Plex Mono',monospace;font-size:9px;font-weight:300;color:rgba(255,183,0,.35);white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
#tleft{font-family:'IBM Plex Mono',monospace;font-size:8px;color:var(--dim);margin-top:2px}
#flash{position:fixed;inset:0;z-index:95;background:#fff;opacity:0;pointer-events:none;transition:opacity .04s}
#flash.on{opacity:.35}
#tunein{position:fixed;inset:0;z-index:300;background:rgba(0,0,0,.93);display:flex;flex-direction:column;align-items:center;justify-content:center;gap:16px;cursor:pointer}
#tunein-label{font-family:'Bebas Neue',cursive;font-size:clamp(38px,7vw,90px);letter-spacing:.1em;color:var(--amber);text-shadow:0 0 40px var(--amber),0 0 80px rgba(255,183,0,.2);text-align:center;line-height:1}
#tunein-sub{font-family:'IBM Plex Mono',monospace;font-size:10px;letter-spacing:.26em;color:var(--dim);text-align:center}
</style>
</head>
<body>
<div id="screen"><video id="player" playsinline preload="auto"></video></div>
<div id="hud">
  <div class="hud-top">
    <div>
      <div class="sid">TVStation<span class="ssub">RFA · BROADCASTING 24/7</span></div>
      <div class="live-row"><div class="dot"></div>LIVE</div>
    </div>
    <div class="clk"><span id="clock">00:00:00</span><div id="dateline"></div></div>
  </div>
  <div class="hud-bot">
    <div class="ptrack"><div id="pfill"></div></div>
    <div class="irow">
      <div class="ncol">
        <div class="lbl">Now Playing</div>
        <div id="now-title">—</div>
        <div id="genre">—</div>
      </div>
      <div class="xcol">
        <div class="lbl" style="text-align:right">Up Next</div>
        <div id="next-title">—</div>
        <div id="tleft">—</div>
      </div>
    </div>
  </div>
</div>
<div id="flash"></div>
<div id="tunein" onclick="tuneIn()">
  <div id="tunein-label">&#9654; CLICK TO<br>TUNE IN</div>
  <div id="tunein-sub">TVStation &middot; RFA 24/7 Broadcast</div>
</div>

<script>
// ═══════════════════════════════════════════════════════════════
//  TVSTATION — SYNCHRONIZED BROADCAST ENGINE
//
//  HOW SYNC WORKS (no server needed):
//  UTC wall-clock time is identical for every viewer on Earth.
//  We compute (UTC seconds since midnight) mod (total block duration)
//  to find exactly which video + which second within it to play.
//  Every browser at the same URL at the same moment sees the same frame.
//
//  HOW LOOPING WORKS:
//  Each language block has a pool of videos. We treat the block's
//  total content as a single looping playlist. Given any UTC second
//  within the block's window, we calculate which video in the pool
//  should be playing and at what offset — even across midnight.
// ═══════════════════════════════════════════════════════════════

const DAY = 86400;

// ── VERIFIED ARCHIVE.ORG IDENTIFIERS ────────────────────────
// All identifiers confirmed to exist on archive.org as youtube-* mirrors.
// Durations are in seconds — kept conservative (shorter than actual)
// so we NEVER seek past the end of a file.

const BLOCKS = [
  {
    name:"普通話 — Mandarin Chinese", genre:"Mandarin Chinese", start:"00:00",
    items:[
      {t:"Hong Kong's Face Readers Reshape the Future",         id:"youtube-MJVRwBrkzsg", dur:260},
      {t:"Hong Kong Protesters Disappointed With Talks",        id:"youtube-hlSlk-vcnRU", dur:190},
      {t:"Chinese Police Quash Month-Long Land Protest",        id:"youtube-jMk4o81qxL0", dur:145},
      {t:"Will Senegal Fall Into a Belt and Road Debt Trap?",   id:"youtube-9w_JnNZtmm0", dur:430},
      {t:"China Culls Thousands of Pigs — African Swine Fever", id:"youtube-4NTCJgWqfwQ", dur:155},
    ]
  },
  {
    name:"မြန်မာဘာသာ — Burmese", genre:"Burmese", start:"02:40",
    items:[
      {t:"Myanmar's Jasmine Garland Sellers Go Back to School",   id:"youtube-9Nma364RVCg", dur:170},
      {t:"Myanmar Insurance Industry Grows As Economy Opens",     id:"youtube-zbq6lEW9FNU", dur:200},
      {t:"Myanmar Faces Flooding Emergency",                      id:"youtube-tkNpWKazyX0", dur:180},
      {t:"RFA Journalist: Access to Credible Information",        id:"youtube-LX50V0DsT_M", dur:140},
    ]
  },
  {
    name:"ខ្មែរ — Khmer (Cambodian)", genre:"Khmer", start:"05:20",
    items:[
      {t:"Forced to Marry by the Khmer Rouge",                   id:"youtube-_H3CS-3xudw", dur:370},
      {t:"Khmer Rouge Survivor: I'm Lucky",                      id:"youtube-xRXQ65UBnU8", dur:260},
      {t:"RFA Journalist Recalls Khmer Rouge Terror",            id:"youtube-GRTXf97PtVI", dur:295},
      {t:"Mekong River Dolphin Tourism Down Sharply in Cambodia", id:"youtube-MazyggOoOyM", dur:200},
    ]
  },
  {
    name:"Tiếng Việt — Vietnamese", genre:"Vietnamese", start:"08:00",
    items:[
      {t:"Will Senegal Fall Into a Belt and Road Debt Trap?",    id:"youtube-9w_JnNZtmm0", dur:430},
      {t:"RFA Journalist: Access to Credible Information",       id:"youtube-LX50V0DsT_M", dur:140},
      {t:"China Culls Thousands of Pigs — African Swine Fever",  id:"youtube-4NTCJgWqfwQ", dur:155},
      {t:"Chinese Police Quash Month-Long Land Protest",         id:"youtube-jMk4o81qxL0", dur:145},
    ]
  },
  {
    name:"བོད་སྐད — Tibetan", genre:"Tibetan", start:"10:40",
    items:[
      {t:"Tibetan Monks Keep Butter Sculpting Tradition Alive",  id:"youtube-yCrVoMKRzZk", dur:250},
      {t:"Tibet Monasteries Observe Major Religious Gathering",  id:"youtube-tmQTUhs_8P4", dur:225},
      {t:"Tibetan Institute of Performing Arts",                 id:"youtube-3b9sG6mBI3k", dur:315},
      {t:"Will Senegal Fall Into a Belt and Road Debt Trap?",    id:"youtube-9w_JnNZtmm0", dur:430},
      {t:"RFA Journalist: Access to Credible Information",       id:"youtube-LX50V0DsT_M", dur:140},
    ]
  },
  {
    name:"廣東話 — Cantonese", genre:"Cantonese", start:"13:20",
    items:[
      {t:"Hong Kong's Face Readers Reshape the Future",          id:"youtube-MJVRwBrkzsg", dur:260},
      {t:"Hong Kong Protesters Disappointed With Talks",         id:"youtube-hlSlk-vcnRU", dur:190},
      {t:"Chinese Police Quash Month-Long Land Protest",         id:"youtube-jMk4o81qxL0", dur:145},
      {t:"Will Senegal Fall Into a Belt and Road Debt Trap?",    id:"youtube-9w_JnNZtmm0", dur:430},
      {t:"China Culls Thousands of Pigs — African Swine Fever",  id:"youtube-4NTCJgWqfwQ", dur:155},
    ]
  },
  {
    name:"ئۇيغۇرچە — Uyghur", genre:"Uyghur", start:"16:00",
    items:[
      {t:"Will Senegal Fall Into a Belt and Road Debt Trap?",    id:"youtube-9w_JnNZtmm0", dur:430},
      {t:"Chinese Police Quash Month-Long Land Protest",         id:"youtube-jMk4o81qxL0", dur:145},
      {t:"China Culls Thousands of Pigs — African Swine Fever",  id:"youtube-4NTCJgWqfwQ", dur:155},
      {t:"RFA Journalist: Access to Credible Information",       id:"youtube-LX50V0DsT_M", dur:140},
    ]
  },
  {
    name:"ພາສາລາວ — Lao", genre:"Lao", start:"17:40",
    items:[
      {t:"Mekong River Dolphin Tourism Down Sharply",            id:"youtube-MazyggOoOyM", dur:200},
      {t:"Will Senegal Fall Into a Belt and Road Debt Trap?",    id:"youtube-9w_JnNZtmm0", dur:430},
      {t:"RFA Journalist: Access to Credible Information",       id:"youtube-LX50V0DsT_M", dur:140},
      {t:"Chinese Police Quash Month-Long Land Protest",         id:"youtube-jMk4o81qxL0", dur:145},
    ]
  },
  {
    name:"한국어 — Korean", genre:"Korean", start:"19:20",
    items:[
      {t:"Defector Tells of Life in North Korea, in Webtoons",   id:"youtube-N8ifVzNyNN4", dur:205},
      {t:"A Beacon of Hope for North Korean Residents",          id:"youtube-Xx3-gW9m5WM", dur:175},
      {t:"North Korea's Kim Plays Down U.S. Diplomacy",          id:"youtube-fthfiSozlBs", dur:155},
      {t:"Will Senegal Fall Into a Belt and Road Debt Trap?",    id:"youtube-9w_JnNZtmm0", dur:430},
      {t:"RFA Journalist: Access to Credible Information",       id:"youtube-LX50V0DsT_M", dur:140},
    ]
  },
  {
    name:"普通話 Prime Time — Mandarin", genre:"Mandarin Chinese", start:"21:40",
    items:[
      {t:"Hong Kong's Face Readers Reshape the Future",          id:"youtube-MJVRwBrkzsg", dur:260},
      {t:"Hong Kong Protesters Disappointed With Talks",         id:"youtube-hlSlk-vcnRU", dur:190},
      {t:"Chinese Police Quash Month-Long Land Protest",         id:"youtube-jMk4o81qxL0", dur:145},
      {t:"Will Senegal Fall Into a Belt and Road Debt Trap?",    id:"youtube-9w_JnNZtmm0", dur:430},
      {t:"China Culls Thousands of Pigs — African Swine Fever",  id:"youtube-4NTCJgWqfwQ", dur:155},
    ]
  },
];

// ── BUILD TIMELINE ───────────────────────────────────────────
function toSec(hhmm){ const[h,m]=hhmm.split(':').map(Number); return h*3600+m*60; }

function buildTimeline(){
  const sorted=BLOCKS.slice().sort((a,b)=>toSec(a.start)-toSec(b.start));
  const tl=[];
  sorted.forEach((block,bi)=>{
    const bStart=toSec(block.start);
    const bEnd=bi+1<sorted.length?toSec(sorted[bi+1].start):DAY;
    let cursor=bStart,i=0;
    while(cursor<bEnd&&i<9999){
      const item=block.items[i%block.items.length];
      const end=Math.min(cursor+item.dur,bEnd);
      tl.push({title:item.t,id:item.id,blockName:block.name,genre:block.genre,startSec:cursor,endSec:end,itemDur:item.dur});
      cursor=end; i++;
    }
  });
  return tl;
}

const TIMELINE=buildTimeline();

// ── CLOCK ────────────────────────────────────────────────────
function utcSec(){ const d=new Date(); return d.getUTCHours()*3600+d.getUTCMinutes()*60+d.getUTCSeconds()+d.getUTCMilliseconds()/1000; }
function findSlot(s){ s=((s%DAY)+DAY)%DAY; const i=TIMELINE.findIndex(x=>s>=x.startSec&&s<x.endSec); return i===-1?0:i; }

const DN=['SUN','MON','TUE','WED','THU','FRI','SAT'],MN=['JAN','FEB','MAR','APR','MAY','JUN','JUL','AUG','SEP','OCT','NOV','DEC'];
const clockEl=document.getElementById('clock'),dateEl=document.getElementById('dateline');
function tickClock(){ const d=new Date(),p=n=>String(n).padStart(2,'0'); clockEl.textContent=`${p(d.getHours())}:${p(d.getMinutes())}:${p(d.getSeconds())}`; dateEl.textContent=`${DN[d.getDay()]} ${d.getDate()} ${MN[d.getMonth()]} ${d.getFullYear()}`; }
setInterval(tickClock,1000); tickClock();

// ── DOM ──────────────────────────────────────────────────────
const player=document.getElementById('player');
const nowTitleEl=document.getElementById('now-title'),genreEl=document.getElementById('genre');
const nextTitleEl=document.getElementById('next-title'),tleftEl=document.getElementById('tleft');
const pfillEl=document.getElementById('pfill'),flashEl=document.getElementById('flash');
const tuneinEl=document.getElementById('tunein');

// ── STATE ────────────────────────────────────────────────────
let currentIdx=-1, tickInterval=null, urlCache={};

// ── URL RESOLUTION ───────────────────────────────────────────
function guessUrl(id){ return `https://archive.org/download/${id}/${id}.ia.mp4`; }

async function resolveUrl(id){
  if(urlCache[id]) return urlCache[id];
  try{
    const r=await fetch(`https://archive.org/metadata/${id}`);
    const meta=await r.json();
    const files=meta.files||[];
    const fns=[
      f=>/\.ia\.mp4$/i.test(f.name),
      f=>/\.mp4$/i.test(f.name)&&f.source==='derivative',
      f=>/\.mp4$/i.test(f.name),
      f=>/\.ogv$/i.test(f.name),
    ];
    let picked=null;
    for(const fn of fns){picked=files.find(fn);if(picked)break;}
    if(picked){
      const url=`https://archive.org/download/${id}/${encodeURIComponent(picked.name)}`;
      urlCache[id]=url; return url;
    }
  }catch(e){console.warn('metadata fail:',id);}
  return guessUrl(id); // last resort
}

// ── CORE PLAY LOGIC ──────────────────────────────────────────
// Key insight: we NEVER seek into a video using the raw wall-clock offset.
// Instead we compute offset MODULO the actual video duration.
// This means if a slot is 260s wide and the video is 260s long,
// we seek to the right second. If somehow duration mismatches,
// we play from 0 (next loop iteration) rather than past the end.

async function playSlot(idx, seekLive){
  if(idx<0||idx>=TIMELINE.length) return;
  currentIdx=idx;
  const slot=TIMELINE[idx];
  updateHUD();

  // Resolve URL
  const url=await resolveUrl(slot.id);

  if(player.src!==url){ player.src=url; player.load(); }

  const doPlay=()=>{
    if(seekLive){
      const now=utcSec();
      // How many seconds into THIS slot are we?
      const slotOffset=Math.max(0, now-slot.startSec);
      // How many seconds into the video file is that?
      // Use modulo so we never seek past the file's end
      const videoDur=player.duration||slot.itemDur;
      const seekTo=slotOffset % videoDur;
      if(seekTo>2 && seekTo<videoDur-1){
        player.currentTime=seekTo;
      }
    }
    player.play().catch(e=>{
      console.warn('play failed for',slot.id,e.message);
      // Skip to next after brief pause
      setTimeout(()=>advance(),1000);
    });
  };

  if(player.readyState>=1) doPlay();
  else player.addEventListener('loadedmetadata',function h(){ player.removeEventListener('loadedmetadata',h); doPlay(); });
}

function advance(){
  flashEl.classList.add('on');
  setTimeout(()=>flashEl.classList.remove('on'),55);
  player.pause();
  // Find correct slot by wall clock (may have drifted during load)
  const ni=findSlot(utcSec());
  const nextIdx= ni===currentIdx ? (currentIdx+1)%TIMELINE.length : ni;
  playSlot(nextIdx, false);
  // Pre-warm next
  const nn=TIMELINE[(nextIdx+1)%TIMELINE.length];
  if(nn&&!urlCache[nn.id]) resolveUrl(nn.id);
}

// ── TICK ─────────────────────────────────────────────────────
function tick(){
  updateHUD();
  const now=utcSec();
  const slot=TIMELINE[currentIdx];
  if(!slot) return;
  if(now>=slot.endSec){
    const ni=findSlot(now);
    if(ni!==currentIdx) advance();
  }
}

// ── HUD ──────────────────────────────────────────────────────
function updateHUD(){
  const slot=TIMELINE[currentIdx]; if(!slot) return;
  const now=utcSec();
  const pct=Math.max(0,Math.min(100,((now-slot.startSec)/(slot.endSec-slot.startSec))*100));
  pfillEl.style.width=pct+'%';
  nowTitleEl.textContent=slot.title;
  genreEl.textContent=(slot.blockName||slot.genre||'BROADCAST').toUpperCase();
  const next=TIMELINE[(currentIdx+1)%TIMELINE.length];
  if(next){ nextTitleEl.textContent=next.title; const s=Math.max(0,Math.round(slot.endSec-now)); tleftEl.textContent=`in ${Math.floor(s/60)}:${String(s%60).padStart(2,'0')}`; }
}

// ── EVENTS ───────────────────────────────────────────────────
player.addEventListener('ended',()=>advance());
player.addEventListener('error',()=>{ console.warn('video error'); setTimeout(advance,800); });

// ── TUNE IN ──────────────────────────────────────────────────
function tuneIn(){
  tuneinEl.style.display='none';
  const idx=findSlot(utcSec());
  playSlot(idx,true);
  const next=TIMELINE[(idx+1)%TIMELINE.length];
  if(next&&!urlCache[next.id]) resolveUrl(next.id);
  if(tickInterval) clearInterval(tickInterval);
  tickInterval=setInterval(tick,500);
}
</script>
</body>
</html>
HTMLEOF
echo "Done — $(wc -l < /mnt/user-data/outputs/tvstation/index.html) lines"
Output
